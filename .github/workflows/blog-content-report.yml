name: Blog Content Report

on:
  schedule:
    - cron: '30 19 * * *'  # 01:00 AM IST
  workflow_dispatch:
    
jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate blog content report
        run: |
          mkdir -p "Daily audits"
          DATE=$(date +%F)
          TIME=$(date '+%H:%M:%S')
          OUTPUT="Daily audits/blog-content-report.md"
          
          echo "# Blog Content Report" > "$OUTPUT"
          echo "" >> "$OUTPUT"
          echo "**Last Updated:** $DATE at $TIME UTC" >> "$OUTPUT"
          echo "" >> "$OUTPUT"
          
          # Count total blog posts
          TOTAL_POSTS=$(ls content/ 2>/dev/null | wc -l)
          echo "## Overview" >> "$OUTPUT"
          echo "" >> "$OUTPUT"
          echo "- 📝 **Total blog posts**: $TOTAL_POSTS" >> "$OUTPUT"
          
          # Check if content directory exists and has files
          if [ -d "content" ] && [ $TOTAL_POSTS -gt 0 ]; then
            echo "" >> "$OUTPUT"
            echo "## Recent Posts" >> "$OUTPUT"
            echo "" >> "$OUTPUT"
            
            # List recent files (last 5)
            ls -t content/ 2>/dev/null | head -5 | while read file; do
              # Get file modification date
              MOD_DATE=$(stat -c %y "content/$file" 2>/dev/null | cut -d' ' -f1 || echo "Unknown")
              echo "- 📄 **$file** (Modified: $MOD_DATE)" >> "$OUTPUT"
            done
            
            echo "" >> "$OUTPUT"
            echo "## Content Statistics" >> "$OUTPUT"
            echo "" >> "$OUTPUT"
            
            # Count different file types if they exist
            MD_COUNT=$(ls content/*.md 2>/dev/null | wc -l || echo 0)
            if [ $MD_COUNT -gt 0 ]; then
              echo "- 📋 **Markdown files**: $MD_COUNT" >> "$OUTPUT"
            fi
            
            # Check for other common blog file types
            for ext in html txt rst; do
              EXT_COUNT=$(ls content/*.$ext 2>/dev/null | wc -l || echo 0)
              if [ $EXT_COUNT -gt 0 ]; then
                echo "- 📋 **$ext files**: $EXT_COUNT" >> "$OUTPUT"
              fi
            done
            
          else
            echo "" >> "$OUTPUT"
            echo "⚠️ **No content directory found or no posts available**" >> "$OUTPUT"
          fi
          
          echo "" >> "$OUTPUT"
          echo "---" >> "$OUTPUT"
          echo "*Generated by GitHub Actions*" >> "$OUTPUT"

      - name: Commit updated report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          DATE=$(date +%F)
          OUTPUT="Daily audits/blog-content-report.md"
          
          if [ -f "$OUTPUT" ]; then
            git add "$OUTPUT"
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Update Blog Content Report - $DATE"
              git push
            fi
          else
            echo "Report file not found, nothing to commit"
            exit 1
          fi